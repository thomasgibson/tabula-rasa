#### Tabula-Rasa
Experimentation repository for the manuscript:

> Thomas H. Gibson, Lawrence Mitchell, David A. Ham, and Colin J. Cotter.
> "A domain-specific language for the hybridization and static condensation of finite element methods".

#### Usage

This repository requires a latest version of Firedrake (https://github.com/firedrakeproject/firedrake).
The paper above contains documentation and references to specific versions of Firedrake used to generate
the results in the paper and its supplement.

Once Firedrake has been obtained and installed, start the virtual environment in each shell from which
you use Firedrake:

```
source firedrake/bin/activate
```

Once the venv is activated, you may run the python scripts in this repository via the standard way:

```
python3 script.py
```

Or in parallel:

```
mpiexec -n N python3 script.py
```

To reproduce the results, you will need to clone the repository SCPC: https://github.com/thomasgibson/scpc,
which contains the python implementations of the static condensation and hybridization preconditioners.
Once SCPC is cloned, simply run `python3 setup.py install` while the Firedrake venv is active. Once it
has finished, all scripts should run correctly.

#### Collecting data

There are four directorys containing scripts for generating and collecting data. The folders
and corresponding run scripts are:

- `CG-SC/run-helmholtz.py` (CG static condensation for a 3D Helmholtz problem)
- `hybrid-mixed/run-hybrid-mixed-tests.py` (Convergence tests for hybridized mixed methods)
- `hybrid-DG/rum-ldg-h-tests.py` (Convergence tests for the LDG-H method)
- `SWE/swe_williamson5.py` (Nonlinear shallow water system on a sphere with an isolated mountain)

The usage as required to reproduce the results in the paper can be obtained via the following commands:
- `mpiexec -n 6 python3 CG-SC/run_helmholtz.py`
- `python3 hybrid-mixed/run-hybrid-mixed-tests.py`
- `python3 hybrid-DG/run-ldg-h-tests.py`

Note that the results in the paper were performed on a 32-core workstation, with each core using an Intel E5-2450v2
(Xeon) CPU at 2.5GHz. Running the commands above will execute convergence tests for the problems detailed in the
manuscript. For the Williamson test case 5, we run this twice using preconditioned GMRES and our hybridization
preconditioner. PETSc log summaries are produced while the simulation runs. To reproduce the profile runs, execute
the following:

```
mpiexec -n 16 python3 swe_williamson5.py --refinements 7 --profile -log_view > output1.log
```
```
mpiexec -n 16 python3 swe_williamson5.py --refinements 7 --profile --hybridization -log_view > output2.log
```

where `outputx.log` can be named however you wish. The first command above will run the simulation using GMRES
on the linearized system with an approximated Schur complement preconditioner. The second command will run the
same simulation, but switches out GMRES with a ``preonly" application of the hybridization preconditioner.
Running `python3 swe_williamson5.py --help` will display a summary of arguments that can be provided.

The `results` directory contains raw data used in the paper. The python scripts in that directory can be used
to reproduce the plots and tables used in the manuscript and supplementary material. Note that the specific
timings presented in the paper were taken directly from the log files generated by PETSc's -log_view.
